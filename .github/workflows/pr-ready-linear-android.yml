# When a PR is ready for review and its linked Linear issue is in review or completed,
# run the app on an Android emulator, run tests, capture screenshots, and update PR description.
# Add LINEAR_API_KEY to repo Secrets (Settings â†’ Secrets and variables â†’ Actions). Link the PR to Linear by including
# the issue identifier (e.g. WORD-123) in the PR title, body, or branch name.

name: PR ready â€“ Linear + Android

on:
  pull_request:
    types: [opened, ready_for_review, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to run tests for'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  run-on-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr = context.payload.pull_request;
            
            // If triggered via workflow_dispatch or push, try to find PR for current branch
            if (!pr) {
              const branch = context.ref.replace('refs/heads/', '');
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch}`,
                state: 'open'
              });
              if (prs.length > 0) {
                pr = prs[0];
              }
            }
            
            if (!pr) {
              core.setOutput('issue_id', '');
              core.setOutput('branch', context.ref.replace('refs/heads/', ''));
              core.setOutput('pr_number', '');
              return;
            }
            
            const text = [pr.title, pr.body || '', pr.head.ref].join(' ');
            // Match Linear-style identifiers: TEAM-123, WORD-42
            const match = text.match(/([A-Za-z]+-\d+)/);
            core.setOutput('issue_id', match ? match[1] : '');
            core.setOutput('branch', pr.head.ref);
            core.setOutput('pr_number', pr.number);

      - name: Check Linear issue is completed
        id: check_linear
        if: steps.pr.outputs.issue_id != ''
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          chmod +x .github/scripts/check-linear-issue.sh
          .github/scripts/check-linear-issue.sh "${{ steps.pr.outputs.issue_id }}"

      - name: Skip â€“ no Linear issue in PR
        if: steps.pr.outputs.issue_id == ''
        run: |
          echo "Skipping: no Linear issue ID in PR title, body, or branch (e.g. WORD-123)."

      - name: Set up Flutter
        if: steps.check_linear.outcome == 'success'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.x"
          channel: stable
          cache: true

      - name: Enable KVM (Android emulator)
        if: steps.check_linear.outcome == 'success'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run tests and integration tests on Android emulator
        id: android_tests
        if: steps.check_linear.outcome == 'success'
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: default
          arch: x86_64
          profile: pixel_7_pro
          script: |
            flutter pub get
            flutter test
            flutter build apk --debug
            # Create screenshots directory
            mkdir -p screenshots
            # Run integration tests to capture screenshots
            flutter test integration_test/screenshot_test.dart --device-id emulator-5554 || true
            # List captured screenshots
            ls -la screenshots/ || echo "No screenshots directory"

      - name: Upload screenshots
        if: steps.check_linear.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots/
          if-no-files-found: warn
          retention-days: 30

      - name: Update PR description with screenshots
        if: steps.check_linear.outcome == 'success' && steps.pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};
            const runId = context.runId;
            const repo = context.repo;
            
            const { data: pr } = await github.rest.pulls.get({
              owner: repo.owner,
              repo: repo.repo,
              pull_number: prNumber,
            });
            
            let body = pr.body || '';
            
            const screenshotSection = [
              '',
              '## ðŸ“± Screenshots (CI Run #' + runId + ')',
              '',
              'Screenshots captured from Android emulator during CI.',
              '',
              '**Download:** [screenshots artifact](https://github.com/' + repo.owner + '/' + repo.repo + '/actions/runs/' + runId + ')',
              '',
              'Screenshots include: main_screen, settings_screen, theme_picker, settings_dark_mode, main_screen_dark_mode',
              ''
            ].join('\n');
            
            const screenshotMarker = '## ðŸ“± Screenshots';
            if (body.includes(screenshotMarker)) {
              const regex = /## ðŸ“± Screenshots[\s\S]*?(?=\n## |$)/;
              body = body.replace(regex, screenshotSection.trim());
            } else {
              body = body + '\n' + screenshotSection;
            }
            
            await github.rest.pulls.update({
              owner: repo.owner,
              repo: repo.repo,
              pull_number: prNumber,
              body: body,
            });
            
            console.log('PR description updated with screenshots section');
